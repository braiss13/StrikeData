@page
@model StrikeData.Pages.PlayerData.FieldingModel

@{
    // Page title for layout and browser tab
    ViewData["Title"] = "Players â€“ Fielding";
}

<h2 class="section-title">Fielding</h2>

<!--
    Team selector:
    - Bound to SelectedTeamId
    - Options come from Model.TeamOptions
    - Auto-submits on change to refresh the table contents
-->
<form method="get">
    <div class="table-selector">
        <select asp-for="SelectedTeamId"
                asp-items="Model.TeamOptions"
                class="form-select w-auto d-inline-block"
                style="background-color:#1e3a8a;
                       color:#ffffff;
                       border:1px solid #2563eb;
                       border-radius:0.25rem;
                       padding:0.4rem 0.8rem;
                       margin-bottom: 1rem;"
                onchange="this.form.submit()">
        </select>
    </div>
</form>

<!--
    Data table:
    - Fixed columns: #, Player, Pos
    - Fielding metrics come from Model.VisibleColumns
    - Tooltips are sourced from Model.StatMeta (LongName + Description)
-->
<table class="table table-striped sortable-table table-bordered table-sm pitching-table table-with-tooltips" style="margin: 1 auto;">
    <thead>
        <tr>
            <th data-sortable data-type="number">#</th>
            <th data-sortable data-type="string">Player</th>
            <th data-sortable data-type="string">Pos</th>

            @* Dynamic metric headers with optional tooltip *@
            @foreach (var col in Model.VisibleColumns)
            {
                var hasMeta = Model.StatMeta.TryGetValue(col, out var meta);
                if (hasMeta && !string.IsNullOrWhiteSpace(meta!.Description))
                {
                    <th data-sortable data-type="number">
                        <span class="stat-head">
                            <span class="stat-abbr"
                                  title=""
                                  tabindex="0"
                                  aria-label="@meta.LongName"
                                  aria-describedby="tip-@col">@col</span>
                            <div id="tip-@col" class="stat-tooltip" role="tooltip">
                                <div class="stat-tooltip-title">@meta.LongName (@col)</div>
                                <div class="stat-tooltip-body">@meta.Description</div>
                            </div>
                        </span>
                    </th>
                }
                else
                {
                    // Render a clean header even when the glossary lacks a description
                    <th>
                        <span class="stat-head">
                            <span class="stat-abbr"
                                  title=""
                                  tabindex="0"
                                  aria-label="@(hasMeta ? meta!.LongName : col)">@col</span>
                        </span>
                    </th>
                }
            }
        </tr>
    </thead>

    <tbody>
    @{
        // 1-based row numbering for readability
        int index = 1;

        if (Model.Rows != null && Model.Rows.Count > 0)
        {
            foreach (var r in Model.Rows)
            {
                <tr>
                    <td>@index</td>
                    <td>@r.Name</td>
                    <td>@(string.IsNullOrWhiteSpace(r.Position) ? "-" : r.Position)</td>

                    @* Metric cells: percentages use 3 decimals; counts render as integers *@
                    @foreach (var col in Model.VisibleColumns)
                    {
                        float? val = null;
                        if (r.Values != null)
                        {
                            r.Values.TryGetValue(col, out var v);
                            val = v;
                        }

                        if (val.HasValue)
                        {
                            var isPercentage = col == "FLD%";
                            <td>
                                @(isPercentage
                                    ? val.Value.ToString("0.000", System.Globalization.CultureInfo.InvariantCulture)
                                    : val.Value.ToString("0", System.Globalization.CultureInfo.InvariantCulture))
                            </td>
                        }
                        else
                        {
                            <td>-</td>
                        }
                    }
                </tr>
                index++;
            }
        }
        else
        {
            // Empty state uses a dynamic colspan: 3 fixed columns + N metrics
            <tr>
                <td colspan="@(3 + Model.VisibleColumns.Count)" style="text-align:center;">
                    No data available
                </td>
            </tr>
        }
    }
    </tbody>
</table>
